<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>
	湖南省中小学教师继续教育网--课程学习
</title><link href="Skin/Learning.css" rel="stylesheet" type="text/css"><link href="Skin/button.css" rel="stylesheet" type="text/css"><link href="Scripts/jquery-ui.css" rel="stylesheet" type="text/css">
     <script type="text/javascript">   
function LearnTimerClient() {
    this.UrlStr_Root = "/LearnTimer"; //学习计时服务器的根Url

    this.UrlStr_Start = "/StartLearning.aspx"; //开始学习的Url
    this.UrlStr_Stop = "/StopLearning.aspx"; //停止学习的Url
    this.UrlStr_Report = "/ReportOfLearning.aspx"; //学习报告的Url
    this.UrlStr_GetVerifyPic = "/GetVerifyPic.aspx"; //获取验证图片的Url
    this.UrlStr_Verify = "/VerifyOfLearning.aspx"; //学习验证的Url

    this.IsInLearning = 0;  //是否正在学习中（用于控制循环报告）
    this.Interval_Report = 60;  //报告的时间间隔（秒）
    this.Interval_Verify = 900;  //验证的时间间隔（秒）
    this.IsVerifying = 0; //是否正在验证中
    this.VerifingTime = 60;  //验证的时间长（秒）
    this.TimingHold; //定义定时器函数的钩子，用于在计时结束时释放定时器

    this.ThisUserId = 0;  //当前用户Id
    this.ThisClassId = '';  //当前班级Id
    this.ThisCourseId = 0;  //当前课程Id
    this.ThisLessonId = 0;  //当前课件Id
    this.LearningStartTime = new Date(); //学习起始时间
    this.LastTime_Report = new Date(); //上次报告时间
    this.LastTime_Verify = new Date(); //上次验证时间
    this.VerifyStartTime = new Date(); //验证起始时间

    this.needLearnTime = 3600; //该课件需要学习的时间（秒）
    this.learnedTime = 0; //该课件以前已学习的时间（秒）

    this.MessageDivId = ""; //消息显示Div的Id
    this.VerifyDailogDivId = ""; //验证对话框的Div的Id
   
    this.Start = function (classId, courseId, lessonId, needLearnTime, learnedTime) {
        
        this.needLearnTime = needLearnTime; //记录本课程需学习的时间
        this.learnedTime = learnedTime; //记录本课程已学习的时间
        if (this.needLearnTime <= this.learnedTime) return; //判断学习时间是否已满足，若满足，不启动计时

        var myUrlStr = this.UrlStr_Root + this.UrlStr_Start;
        var myThis = this; //传递this到内部创建的函数
        //启动学习计时
        
        $.ajax({
            
            url: myUrlStr,
            dataType: "json",
            type: 'POST',
            cache: false,
            async: true,
            data: {inClassId: classId, inCourseId: courseId, inLessonId: lessonId },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                alert("开始学习计时发生错误，连接计时服务器失败，错误信息：" + errorThrown);
            },
            success: function (data) {
                if (data.Value < 0) {
                    alert("开始学习失败，错误信息：" + data.Message);
                }
                else {
                    myThis.IsInLearning = 1; //将学习状态置为1
                    //myThis.ThisUserId = userId;  //当前用户Id
                    myThis.ThisClassId = classId; //设置当前班级Id
                    myThis.ThisCourseId = courseId; //设置当前课程Id
                    myThis.ThisLessonId = lessonId; //设置当前课件Id
                    myThis.LearningStartTime = myThis.LearningStartTime; //设置学习起始时间
                    myThis.LastTime_Report = myThis.LearningStartTime; //设置学习起始时间
                    myThis.LastTime_Verify = myThis.LearningStartTime; //设置学习起始时间

                    myThis.ShowLearnMsg(); //刷新显示学习信息

                    var myThisTimer = myThis; //再次传递myThis(this)到下级内部创建的函数
                    setTimeout(function () { myThisTimer.Timeing(); }, 1000); //1秒后启动定时处理程序
                }
            }
        });
    }

    this.Stop = function () {
        if (this.IsInLearning == 0) return; //若当前学习为停止状态，直接返回
        var myUrlStr = this.UrlStr_Root + this.UrlStr_Stop;
        this.IsInLearning = 0; //将学习状态置为0
        var myThis = this; //传递this到内部创建的函数
        var myDate = new Date();
        $.ajax({
            url: myUrlStr,
            dataType: "json",
            type: 'POST',
            cache: false,
            async: false,
            data: { inClassId: myThis.ThisClassId, inCourseId: myThis.ThisCourseId, inLessonId: myThis.ThisLessonId },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                alert("停止学习计时发生错误，连接计时服务器失败，错误信息：" + errorThrown);
            },
            success: function (data) {
                if (data.Value < 0) {
                    //错误，停止学习
                    myThis.IsInLearning = 0; //将学习状态置为0（控制学习报告和验证不执行）
                    alert("停止学习失败，错误信息：" + data.Message);
                }
                else {
                    var myNowTime = new Date();
                    var myThisLearnedSec = Math.floor((myNowTime.getTime() - myThis.LearningStartTime.getTime()) / 1000);
                    alert("停止学习成功，本次共学习了" + myThisLearnedSec + "秒！本次学习的记录保存到数据库需要一定的时间，因此您查询学习时间可能发现与实际情况有差异，可稍等片刻后刷新再查看。");
                }
            }
        });
    }

    this.StopOnTimeOver = function () {
        if (this.IsInLearning == 0) return; //若当前学习为停止状态，直接返回
        var myUrlStr = this.UrlStr_Root + this.UrlStr_Stop;
        this.IsInLearning = 0; //将学习状态置为0
        var myThis = this; //传递this到内部创建的函数
        var myDate = new Date();
        $.ajax({
            url: myUrlStr,
            dataType: "json",
            type: 'POST',
            cache: false,
            async: false,
            data: { inClassId: myThis.ThisClassId, inCourseId: myThis.ThisCourseId, inLessonId: myThis.ThisLessonId },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                alert("学习时间已满，自动停止学习计时发生错误，连接计时服务器失败，错误信息：" + errorThrown);
            },
            success: function (data) {
                alert("学习时间已满，学习计时自动停止！");
            }
        });
    }

    this.Timeing = function () {
        if (this.IsInLearning == 0) return; //若学习状态为0，直接返回
        if (this.needLearnTime <= this.learnedTime)  //判断学习时间是否已满足，若满足，停止计时
        {
            this.StopOnTimeOver(); //停止计时
            return;
        }
        var myNowTime = new Date(); //当前时间

        this.ShowLearnMsg(); //刷新显示学习信息

        //如果上次报告已达到报告的时间间隔，报告服务器
        if (Math.floor(myNowTime.getTime() - this.LastTime_Report.getTime()) >= this.Interval_Report * 1000) {
            this.Report();
        }
        //如果上次验证已达到验证的时间间隔，发起验证
        if (Math.floor((myNowTime.getTime() - this.LastTime_Verify.getTime()) / 1000 ) >= this.Interval_Verify) {
            if (this.IsVerifying == 0) {
                //未在验证中，发起验证
                this.Verify();
                this.IsVerifying = 1;
                this.VerifyStartTime = myNowTime; //设置验证起始时间
            }
            else {
                //刷新验证时间

                //判断验证是否超时
                if (Math.floor((myNowTime.getTime() - this.VerifyStartTime.getTime()) / 1000) >= this.VerifingTime) {
                    //验证超时
                    //this.Stop(); //停止学习计时
                    //$("#" + this.VerifyDailogDivId).hide(); //隐藏验证窗体
                    //this.IsVerifying = 0; //设置验证状态为关闭
                    //alert("填写验证码超时，学习停止！");
                    //return; //直接返回，不再刷新计时信息
                }
            }
        }
        var myThis = this; //传递this到下级内部创建的函数
        setTimeout(function () { myThis.Timeing(); }, 1000); //1秒后启动定时处理程序（设置释放的钩子）
    }

    this.Report = function () {
        if (this.IsInLearning == 0) return; //若学习状态为0，直接返回
        var myUrlStr = this.UrlStr_Root + this.UrlStr_Report;
        var myThis = this; //传递this到内部创建的函数
        var myDate = new Date();
        $.ajax({
            url: myUrlStr,
            dataType: "json",
            type: 'POST',
            cache: false,
            async: true,
            data: { inClassId: myThis.ThisClassId, inCourseId: myThis.ThisCourseId, inLessonId: myThis.ThisLessonId },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                //alert("发送学习计时报告信息发生错误，连接计时服务器失败，错误信息：" + errorThrown);
            },
            success: function (data) {
                if (data.Value < 0) {
                    //错误，停止学习
                    myThis.IsInLearning = 0; //将学习状态置为0（控制学习报告和验证不执行）
                    alert("学习报告失败，原因：" + data.Message);
                }
                else {
                    //计算已学习时间
                    myThis.learnedTime = myThis.learnedTime + Math.floor((myDate.getTime() - myThis.LastTime_Report.getTime()) / 1000)
                    //记录本次报告时间
                    myThis.LastTime_Report = myDate;

                    myThis.ShowLearnMsg(); //刷新显示学习信息

                }
            }
        });
    }

    this.Verify = function () {
        if (this.IsInLearning == 0) return; //若学习状态为0，直接返回
        var myMessageDivId = this.MessageDivId;
        var myDate = new Date();
        //刷新验证码图片
        this.RefVerifyPic();
        var myThis = this; //传递this到内部创建的函数
        //显示对话框
        $("#" + this.VerifyDailogDivId).show();
    }

    this.RefVerifyPic = function ()
    {
        //刷新验证码图片
        var myVerifyPicUrl = this.UrlStr_Root + this.UrlStr_GetVerifyPic + "?rdm=" + Math.random();
        $("#" + this.VerifyDailogDivId + " img").attr("src", myVerifyPicUrl);
    }

    this.DoVerify = function () {
        $("#" + this.VerifyDailogDivId).hide(); //隐藏对话框
        var myUrlStr = this.UrlStr_Root + this.UrlStr_Verify;
        var myThis = this; //传递this到内部创建的函数
        var myVerifyCode = $("#" + this.VerifyDailogDivId + " input").val();
        var myDate = new Date();
        $.ajax({
            url: myUrlStr,
            dataType: "json",
            type: 'POST',
            cache: false,
            async: true,
            data: {
                inClassId: myThis.ThisClassId, inCourseId: myThis.ThisCourseId, inLessonId: myThis.ThisLessonId,
                inVerifyCode: myVerifyCode
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                alert("发送学习计时验证信息发生错误，连接计时服务器失败，错误信息：" + errorThrown);
            },
            success: function (data) {
                if (data.Value < 0) {
                    if (data.Value == -8000) {
                        //验证码输入错误，重输
                        alert(data.Message);
                        myThis.Verify();
                    }
                    else {
                        //错误，停止学习
                        myThis.IsInLearning = 0; //将学习状态置为0（控制学习报告和验证不执行）
                        alert("学习验证失败，原因：" + data.Message);
                        if (confirm('你是否重新开始学习？') == true) {
                            window.location.reload();
                        }
                    }
                }
                else {
                    //计算已学习时间
                    myThis.learnedTime = myThis.learnedTime + Math.floor((myDate.getTime() - myThis.LastTime_Report.getTime()) / 1000)
                    //变更上次验证时间
                    myThis.LastTime_Verify = myDate;
                    //同步变更本次报告时间
                    myThis.LastTime_Report = myDate;
                    //设置当前验证状态为0（验证完成）
                    myThis.IsVerifying = 0;

                    myThis.ShowLearnMsg(); //刷新显示学习信息
                }
            }
        });
    }

    this.ShowLearnMsg = function () {
        var myMessageDivId = this.MessageDivId;
        //显示已学习时间（按分钟显示）
        $('#' + myMessageDivId + " span:eq(1)").html(Math.floor(this.learnedTime / 60));
        //显示学习起始时间
        //$('#' + myMessageDivId + " span:eq(0)").html(myThis.LearningStartTime.toLocaleTimeString());
        //显示上次验证时间
        //$('#' + myMessageDivId + " span:eq(1)").html(myThis.LearningStartTime.toLocaleTimeString());
        //显示下次验证时间
        //$('#' + myMessageDivId + " span:eq(3)").html(myThis.Interval_Verify);
    }


}
</script>
    <style>
        iframe{ 
v:expression(this.src='about:blank',this.outerHTML=''); 
}
    </style>
</head>
<body>
    
    <!-- 引用计时器JS -->
  

    <script type="text/javascript">   
        //var refurl=document.referrer;
        var myUserId = 781251 ; //用户Id
        var myClassId = 'CAA887DC-F767-4F3A-9266-65823DF235CB'; //班级Id
        var myCourseId = 3330 ; //课程Id
        var myLessonId = 32648 ; //课件Id
        var myNeedLearnTime = 120 * 60; //需学习的时间（秒）
        var myLearnedTime = 1227 ; //已学习的时间（秒）
        var myLearnTimerClient = new LearnTimerClient();
        $(function () {
            myLearnTimerClient.MessageDivId = "Div_LearningTimer";
            myLearnTimerClient.VerifyDailogDivId = "VerifyDailogBox";
            myLearnTimerClient.Start(myClassId, myCourseId, myLessonId, myNeedLearnTime, myLearnedTime); //开始学习
        });
        function exit() {
            if (myLearnTimerClient.IsInLearning == 1) {
                if (confirm('你确定要停止学习吗？') != true) {
                    return false;
                }
                myLearnTimerClient.Stop(); //停止学习
            }
            var Flag='';
            if(Flag=='CLASS')
            {
                var myurl=GetQueryString("refurl");
                if(myurl !=null && myurl.toString().length>1)
                {
                    window.location.href=myurl;
                }
                //window.location.href=
                //window.history.go(-1);
                //window.location.href='../HTML/WorkShop/workshop-course.html?WorkShopID='+'CAA887DC-F767-4F3A-9266-65823DF235CB';
                //window.location.href='../Elearning/ClassManage/TS_Index.aspx?Jump=true';
                //window.location.href='../Elearning/ClassManage/ClassResource/ViewResource.aspx';
               //window.location.href='../Elearning/ClassManage/ClassResource/ViewResource.aspx';
            }
            else
            {
                var myurl=GetQueryString("refurl");
                if(myurl !=null && myurl.toString().length>1)
                {
                    window.location.href=myurl;
                }
                //window.location.href=
                //window.history.go(-1);
                //window.location.href='../HTML/WorkShop/workshop-course.html?WorkShopID='+'CAA887DC-F767-4F3A-9266-65823DF235CB';
            }
            //history.go(-1);
        }

        function GetQueryString(name)
        {
            var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
            var r = window.location.search.substr(1).match(reg);
            if(r!=null)return  unescape(r[2]); return null;
        }
      
    </script>

    <div id="wrapper">
        <h1 class="lesson-title">解读《学记》</h1>
        <div class="wrapper-inner">
            <!--学习时间显示窗-->
            <div class="learn-box clear" id="Div_LearningTimer" style="position:relative;">
                <dl class="clear time-left">
                    <dt></dt>
                    <dd>本课件需学习<span class="yellow">120</span>分钟，</dd>
                    <dd>您已经学习了<span class="yellow">20</span>分钟。</dd>
                    <dd class="s-r"><a href="#" onclick="exit();">退出</a></dd>
                </dl>
                <div style="position: absolute;left:990px; top: 86px;  ">
            <div id="gksb" style="float: left;width:46px; height: 123px;"><img src="../images/gksb.gif"></div>
            <div id="divessay" style="border: 1px solid #28a2e8;width:300px ;margin-top:-123px ;margin-left:50px ;  display:none; float:left; height:500px"><textarea name="a" id="txt_essay" style="border:solid 1px #b6dff7; width:280px; height:430px; margin:10px 0 0 10px"></textarea><input type="button" value=" " id="btn_save" style="width:59px;height:33px;margin:10px 0 0 10px; border:none; background:url(../images/bc.gif)" ;=""><span style="color:red; margin:10px;">温馨提示：20字以下的“观课随笔”考核时不予计分</span></div>
                </div>
            </div>
            
            <div id="VerifyDailogBox" class="rz-box" style="display: none; border: 1px solid #eee; padding: 10px; font-size: 14px; text-align: center;">
                <label><strong>请输入运算结果 ：
                    <span style="position: relative; top: 4px;"><img src="" style="width: 100px; height: 20px;"></span>
                </strong></label><input type="text" style="width: 30px;" maxlength="2">
                &nbsp;<input type="button" class="b01" onclick="myLearnTimerClient.DoVerify();" value="确定">
                &nbsp;<a href="##" style="color: #336699;" onclick="myLearnTimerClient.RefVerifyPic();">换一个</a>
            </div>
            <!--课件播放窗口-->
            
            
     


            
            
         
    <iframe src="http://srv.hnteacher.net/media/html/2017lxw/2017zhctwhsy-19/index.html" marginwidth="0" marginheight="0" frameborder="0" scrolling="auto" style="width: 100%; min-height: 590px; height: auto; margin-top: 10px;"></iframe>

            
            <!--课件简介-->
            <div class="video-info">
                <p>解读《学记》</p>
            </div>
        </div>
    </div>
    
<script type="text/javascript">
    var essaystaut=0;
    $("#gksb").click(function(){
        if(essaystaut==0){
            $("#divessay").show(1000);
            essaystaut=1;
        }else{
            $("#divessay").hide(1000);
            essaystaut=0;
      
        }
    })

    $("#btn_save").click(function(){
        var essayIds="0";
        var essay=$("#txt_essay").val();
        if(essay.replace(/(^\s+)|(\s+$)/g, "")==""){
            alert("随笔不能为空!");return;
        }
        var ClassId="CAA887DC-F767-4F3A-9266-65823DF235CB";
        var CourseId="3330";
        var LessonInfoId="32648";
        var UserId ="781251";

        $.ajax({
            url: "/Learning/Learning.aspx",
            dataType: "text",
            data:"type=Save&Context="+encodeURI(essay)+"&ClassId="+ClassId+"&CourseId="+CourseId+"&LessonInfoId="+LessonInfoId+"&UserId="+UserId,
            type: 'POST',
            cache: false,
            async: true,
            success: function (data) {
                if(data=="True"){
                    alert("保存成功!");
                    essayIds=1;
                }
            }
        });
    })

</script>


</body></html>